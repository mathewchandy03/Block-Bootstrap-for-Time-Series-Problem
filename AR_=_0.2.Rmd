---
title: "Tests for AR = 0.2"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We need all necessary functions:

```{r functions, echo = FALSE}
nmblk <- function(n, l) {
  b <- n / l # assuming that is an integer
  idx <- sample(seq(1, n - l + 1, by = l), b, replace = TRUE) # Sample between 1 and n - l + 1, 
  # separating by l, b times
  c(outer(0:(l - 1), idx, "+")) # Creates a vector listing random blocks of size l with starting points 
  # decided by idx
}

mvblk <- function(n, l) {
  b <- n / l
  idx <- sample(1:(n - l + 1), b, replace = TRUE) # Sample any starting point between 1 and n - 1 + 1
  # they can overlap
  c(outer(0:(l - 1), idx, "+")) # Creates a vector listing random blocks of size l with starting points
  # decided by idx
}

blkboot <- function(tseries, statistic, R, l) {
  n <- length(tseries) 
  ## observed statistic
  stat <- statistic(tseries) #stat stores a certain statistic of tseries using a function
  ## nonmoving block bootstrap
  nm.stat <- replicate(R, statistic(tseries[nmblk(n, l)])) # finds the statistic of nm bootstrap and repeats R times
  ## moving block bootstrap
  mv.stat <- replicate(R, statistic(tseries[mvblk(n, l)])) # finds the statistic of mv bootstrap and repeats R times
  list(stat = stat, nm.stat = nm.stat, mv.stat = mv.stat) # returns list of three values
}

do1rep <- function(n, theta, sd, l, statistic) {
  x <- arima.sim(list(ar = theta), n = n, sd = sd) 
  
  # sd is the standard deviation of the noise -> true_variance(X_t) = sd^2/(1 - theta^2)
  
  bt <- blkboot(x, statistic, 1000, l) 

 # nm_lower_bound with quantile function
  
  nm_interval = quantile(bt$nm.stat, probs = c(0.025, 0.975))
  mv_interval = quantile(bt$mv.stat, probs = c(0.025, 0.975))
  
  nm_contains = FALSE
  if (nm_interval[1] < 0 && nm_interval[2] > 0)
  {
    nm_contains = TRUE
  }
  mv_contains = FALSE
  if (mv_interval[1] < 0 && mv_interval[2] > 0)
  {
    mv_contains = TRUE
  }
  
  c(bt$stat, sd(bt$nm.stat), nm_interval, nm_contains, sd(bt$mv.stat), mv_interval, mv_contains) 

    # returns statistics and standard error's for nm and mv respectively, standard error (sd(bt$mv.stat) is estimated as the sqrt(sample_variance(X_t) / n)
  
}
```

```{r functions, echo = False}
options(max.print = 1000000)
ar1 <- function(x) cor(x[-1], x[-length(x)])
m1 <- function(x) mean(x)

my_summary <- function(x)
{
  rm = rowMeans(x)
  c(rm, sd(x[1,]), rm[2] - sd(x[1,]), rm[6] - sd(x[1,]), (rm[2] - sd(x[1,])) / sd(x[1,]), (rm[6] - sd(x[1,])) / sd(x[1,]))
}



```

Let's start with n = 400. We want l to decrease as n decreases, but we also want the ratio k (l / n) to increase, so we can set l = sqrt(n). For n = 400, l = 20. We can do 3 trials each for 3 different sigmas.

```{r functions, echo = False}
t1 <- replicate(3, my_summary(replicate(100, do1rep(400, 0.2, 0.1, 20, m1))))
print(t1)
```

```{r functions, echo = False}
t2 <- replicate(3, my_summary(replicate(100, do1rep(400, 0.2, 1, 20, m1))))
print(t2)
```

```{r functions, echo = False}
t3 <- replicate(3, my_summary(replicate(100, do1rep(400, 0.2, 10, 20, m1))))
print(t3)
```

As expected, the coverage rates for 95% confidence intervals at this sample size are generally close to 95%. We also observe that this is true regardless of sigma.

Now let's try it with n = 361 and l = 19.
```{r functions, echo = False}
t4 <- replicate(3, my_summary(replicate(100, do1rep(361, 0.2, 0.1, 19, m1))))
print(t4)
```

```{r functions, echo = False}
t5 <- replicate(3, my_summary(replicate(100, do1rep(324, 0.2, 0.1, 18, m1))))
print(t5)
```

```{r functions, echo = False}
t6 <- replicate(3, my_summary(replicate(100, do1rep(289, 0.2, 0.1, 17, m1))))
print(t6)
```

At this n, we begin to observe more coverage rates below .90. The highest observation is .90 for the trial 2 moving block bootstrap, and the lowest observation is .85 for the trial 3 non-moving block bootstrap. Until now, we have only observed coverage rates above .87. If we run it again, we observe acceptable coverage rates. Still, this shows that even at this sample size, we can observe success rates that are not acceptable. Let's go to the next lowest n that is a square of some l.

```{r functions, echo = False}
tt <- replicate(3, my_summary(replicate(100, do1rep(289, 0.2, 0.1, 17, m1))))
print(tt)
```

```{r functions, echo = False}
t7 <- replicate(3, my_summary(replicate(100, do1rep(256, 0.2, 0.1, 16, m1))))
print(t7)
```

At this n, the coverage rates seem to be generally close to .95, so it seems like the trials for n = 289 may just have been a bit unlucky.

```{r functions, echo = False}
t8 <- replicate(3, my_summary(replicate(100, do1rep(225, 0.2, 0.1, 15, m1))))
print(t8)
```

```{r functions, echo = False}
t9 <- replicate(3, my_summary(replicate(100, do1rep(196, 0.2, 0.1, 14, m1))))
print(t9)
```

```{r functions, echo = False}
t10 <- replicate(3, my_summary(replicate(100, do1rep(169, 0.2, 0.1, 13, m1))))
print(t10)
```

At this n, 4 of the 6 coverage rates observed are below .90. This is first sample size at which we have observed a coverage rate below .85. The highest coverage rate observed is .93.

```{r functions, echo = False}
t11 <- replicate(3, my_summary(replicate(100, do1rep(144, 0.2, 0.1, 12, m1))))
print(t11)
```

These coverage rates seem to be better than those for n = 163, although it is not great, with two success rates below .90.

```{r functions, echo = False}
t12 <- replicate(3, my_summary(replicate(100, do1rep(121, 0.2, 0.1, 11, m1))))
print(t12)
```

Three coverage rates below .90, and only one above .90.

```{r functions, echo = False}
t13 <- replicate(3, my_summary(replicate(100, do1rep(100, 0.2, 0.1, 10, m1))))
print(t13)
```

four coverage rates below .90.

```{r functions, echo = False}
t14 <- replicate(3, my_summary(replicate(100, do1rep(81, 0.2, 0.1, 9, m1))))
print(t14)
```

Four coverage rates below .90. Highest coverage rate is .94.

```{r functions, echo = False}
t15 <- replicate(3, my_summary(replicate(100, do1rep(64, 0.2, 0.1, 8, m1))))
print(t15)
```

Five coverage rates below .90, and one below .85. 

So it seems that the coverage rates are now clearly below .95, so the question is at what range of sample sizes do the coverage rates become unacceptable. When n was 289, we observed 5 coverage rates below .90, but for n's below that we observed acceptable coverage rates. Still, the fact that we observed such low coverage rates for this sample size shows that the variance can be heavily underestimated for sample sizes of this size. Once n hit 169, at least 2 coverage rates were below .90 for each sample size after that.
