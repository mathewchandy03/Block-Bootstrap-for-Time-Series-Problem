```{r functions}
## This note checks the empirical coverage rate of CIs constructed from
## block bootstrap with series generated from an MA process

mystat <- function(x) {
    c(mean(x),
      sd(x),
      cor(x[-1], x[-length(x)]))
      # acf(x, lag.max = 1, plot = FALSE)$acf[2])
}

do1rep <- function(n, theta, statistic, blksize, R = 1000, level = .95) {
    x <- arima.sim(list(ma = theta), n = n) / sqrt(1 + theta^2)
    bts <- boot::tsboot(x, statistic, l = blksize, sim = "fixed", R = R)
    alpha <- 1 - level
    ## returns a vector with length twice of that of mystat's returned values
    ## each pair forms an interval for one target
    pctCI <- apply(bts$t, 2, quantile, prob = c(alpha/2, 1 - alpha/2))
    empCI <- matrix(2 * bts$t0, 2, length(bts$t0), byrow = TRUE) - pctCI[c(2, 1),]
    ## BCa interval
    z0 <- qnorm(colMeans(sweep(bts$t, 2, bts$t0) < 0))
    ## thetajack <- sapply(1:n, function(i) statistic(x[-i]))
    thetajack <- sapply(1: (n / blksize),
                        function(i) statistic(x[ - ((i - 1) * blksize + 1:blksize)]))
    a <- apply(thetajack, 1, e1071::skewness) / 6
    alpha1 <- pnorm(z0 + (z0 + qnorm(alpha/2)) / (1 - a * (z0 + qnorm(alpha/2))))
    alpha2 <- pnorm(z0 + (z0 + qnorm(1 - alpha/2)) / (1 - a * (z0 + qnorm(1 - alpha/2))))
    bcaCI <- sapply(1:length(bts$t0),
                    function(i) quantile(bts$t[,i], prob = c(alpha1[i], alpha2[i])))
    ## return all intervals
    c(pctCI, empCI, bcaCI)
}
    
mychk <- function(sim, target) {
    p <- nrow(sim) / length(target) / 2
    target <- rep(target, p)
    ret <- rep(NA, length(target))
    for (i in seq_along(ret)) {
        ii <- (i - 1) * 2
        ret[i] <- mean(sim[ii + 1,] < target[i] & target[i] < sim[ii + 2,])
    }
    ret
}
```

```{r simulation}
nrep <- 4000
```

```{r ma = .1, n = 125}
n <- 125
blksize <- 5
theta <- .1
target <- c(0, 1, theta / (1 + theta^2))
set.seed(1234)
sim_.1_125 <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.1_125, target)
```

```{r ma = .1, n = 1000}
n <- 1000
blksize <- 10
theta <- .1
target <- c(0, 1, theta / (1 + theta^2))
set.seed(2345)
sim_.1_1k <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.1_1k, target)
```

```{r ma = .1, n = 3375}
n <- 3375
blksize <- 15
theta <- .1
target <- c(0, 1, theta / (1 + theta^2))
set.seed(3456)
sim_.1_3375 <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.1_3375, target)
```

```{r ma = .3, n = 125}
n <- 125
blksize <- 5
theta <- .3
target <- c(0, 1, theta / (1 + theta^2))
set.seed(1234)
sim_.3_125 <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.3_125, target)
```

```{r ma = .3, n = 1000}
n <- 1000
blksize <- 10
theta <- .3
target <- c(0, 1, theta / (1 + theta^2))
set.seed(2345)
sim_.3_1k <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.3_1k, target)
```

```{r ma = .3, n = 3375}
n <- 3375
blksize <- 15
theta <- .3
target <- c(0, 1, theta / (1 + theta^2))
set.seed(3456)
sim_.3_3375 <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.3_3375, target)
```

```{r ma = .3, n = 8000}
n <- 8000
blksize <- 20
theta <- .3
target <- c(0, 1, theta / (1 + theta^2))
set.seed(4567)
sim_.3_8k <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.3_8k, target)
```

```{r ma = .5, n = 3375}
n <- 3375
blksize <- 15
theta <- .5
target <- c(0, 1, theta / (1 + theta^2))
set.seed(3456)
sim_.5_3375 <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.5_3375, target)
```

```{r ma = .5, n = 8000}
n <- 8000
blksize <- 20
theta <- .5
target <- c(0, 1, theta / (1 + theta^2))
set.seed(4567)
sim_.5_8k <- replicate(nrep, do1rep(n, theta, mystat, blksize))
mychk(sim_.5_8k, target)
```

```{r}
write.csv(sim_.1_125,"../Data/Raw/sim_.1_125.csv", row.names = FALSE)
write.csv(sim_.1_1k,"../Data/Raw/sim_.1_1k.csv", row.names = FALSE)
write.csv(sim_.3_125,"../Data/Raw/sim_.3_125.csv", row.names = FALSE)
write.csv(sim_.3_1k,"../Data/Raw/sim_.3_1k.csv", row.names = FALSE)
write.csv(sim_.3_3375,"../Data/Raw/sim_.3_3375.csv", row.names = FALSE)
write.csv(sim_.3_8k,"../Data/Raw/sim_.3_8k.csv", row.names = FALSE)
```

