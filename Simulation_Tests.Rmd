---
title: "Simulation_Tests"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We need all necessary functions:

```{r functions, echo = FALSE}
nmblk <- function(n, l) {
  b <- n / l # assuming that is an integer
  idx <- sample(seq(1, n - l + 1, by = l), b, replace = TRUE) # Sample between 1 and n - l + 1, 
  # separating by l, b times
  c(outer(0:(l - 1), idx, "+")) # Creates a vector listing random blocks of size l with starting points 
  # decided by idx
}

mvblk <- function(n, l) {
  b <- n / l
  idx <- sample(1:(n - l + 1), b, replace = TRUE) # Sample any starting point between 1 and n - 1 + 1
  # they can overlap
  c(outer(0:(l - 1), idx, "+")) # Creates a vector listing random blocks of size l with starting points
  # decided by idx
}

blkboot <- function(tseries, statistic, R, l) {
  n <- length(tseries) 
  ## observed statistic
  stat <- statistic(tseries) #stat stores a certain statistic of tseries using a function
  ## nonmoving block bootstrap
  nm.stat <- replicate(R, statistic(tseries[nmblk(n, l)])) # finds the statistic of nm bootstrap and repeats R times
  ## moving block bootstrap
  mv.stat <- replicate(R, statistic(tseries[mvblk(n, l)])) # finds the statistic of mv bootstrap and repeats R times
  list(stat = stat, nm.stat = nm.stat, mv.stat = mv.stat) # returns list of three values
}

do1rep <- function(n, theta, sd, l, statistic) {
  x <- arima.sim(list(ar = theta), n = n, sd = sd) 
  
  # sd is the standard deviation of the noise -> true_variance(X_t) = sd^2/(1 - theta^2)
  
  bt <- blkboot(x, statistic, 1000, l) 

 # nm_lower_bound with quantile function
  
  nm_interval = quantile(bt$nm.stat, probs = c(0.025, 0.975))
  mv_interval = quantile(bt$mv.stat, probs = c(0.025, 0.975))
  
  nm_contains = FALSE
  if (nm_interval[1] < 0 && nm_interval[2] > 0)
  {
    nm_contains = TRUE
  }
  mv_contains = FALSE
  if (mv_interval[1] < 0 && mv_interval[2] > 0)
  {
    mv_contains = TRUE
  }
  
  c(bt$stat, sd(bt$nm.stat), nm_interval, nm_contains, sd(bt$mv.stat), mv_interval, mv_contains) 

    # returns statistics and standard error's for nm and mv respectively, standard error (sd(bt$mv.stat) is estimated as the sqrt(sample_variance(X_t) / n)
  
}
```

Let's conduct a simulation study with n = 100, ar = 0.1, and sd = 0.1 (var = 0.01)

```{r functions, echo = False}
options(max.print = 1000000)
ar1 <- function(x) cor(x[-1], x[-length(x)])
m1 <- function(x) mean(x)

my_summary <- function(x)
{
  rm = rowMeans(x)
  c(rm, sd(x[1,]), rm[2] - sd(x[1,]), rm[6] - sd(x[1,]), (rm[2] - sd(x[1,])) / sd(x[1,]), (rm[6] - sd(x[1,])) / sd(x[1,]))
}



```

Let's first do this while keeping l = 10 constant.

```{r functions, echo = False}
c1_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c1_1.data = rbind(c1_1.data, tobind.data)
  }
}

print(c1_1.data)
```
There doesn't seem to be any clear pattern when looking at these larger sample sizes. Let's zoom in a little.

```{r functions, echo = False}
install.packages("ggplot2")
library(ggplot2)

test_reshaped <- data.frame(x = c1_1.data$n,                           
                       y = c(c1_1.data$nm_percent_diff, c1_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c1_1.data)),
                                 rep("Moving Percent Difference", nrow(c1_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()



```

```{r functions, echo = False}
c2_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c2_1.data = rbind(c2_1.data, tobind.data)
  }
}

print(c2_1.data)
```
The pattern is not super clear, although it seems to begin to increasingly underestimate somewhere around n = 200.

```{r functions, echo = False}
install.packages("ggplot2")
library(ggplot2)

test_reshaped <- data.frame(x = c2_1.data$n,                           
                       y = c(c2_1.data$nm_percent_diff, c2_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c2_1.data)),
                                 rep("Moving Percent Difference", nrow(c2_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
c3_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c3_1.data = rbind(c3_1.data, tobind.data)
  }
}

print(c3_1.data)
```
For these smaller sample sizes, it seems to have a tendency to increasingly underestimate as n decreases. A notable drop occurs around n = 40.
 
```{r functions, echo = False}
install.packages("ggplot2")
library(ggplot2)

test_reshaped <- data.frame(x = c3_1.data$n,                           
                       y = c(c3_1.data$nm_percent_diff, c3_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c3_1.data)),
                                 rep("Moving Percent Difference", nrow(c3_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
c4_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c4_1.data = rbind(c4_1.data, tobind.data)
  }
}

print(c4_1.data)
```
Again, for these smaller sample sizes, it seems to have a tendency to increasingly underestimate as n decreases. Notable drops occur around n = 50 and n = 20.

```{r functions, echo = False}

test_reshaped <- data.frame(x = c4_1.data$n,                           
                       y = c(c4_1.data$nm_percent_diff, c4_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c4_1.data)),
                                 rep("Moving Percent Difference", nrow(c4_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```
Let's try this while keeping the ratio n/l = 10 constant.

```{r functions, echo = False}
l1_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l1_1.data = rbind(l1_1.data, tobind.data)
  }
}

print(l1_1.data)
```
There is no pattern for these larger sample sizes, let's zoom in.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l1_1.data$n,                           
                       y = c(l1_1.data$nm_percent_diff, l1_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l1_1.data)),
                                 rep("Moving Percent Difference", nrow(l1_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l2_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l2_1.data = rbind(l2_1.data, tobind.data)
  }
}

print(l2_1.data)
```
Again, there is really no pattern here.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l2_1.data$n,                           
                       y = c(l2_1.data$nm_percent_diff, l2_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l2_1.data)),
                                 rep("Moving Percent Difference", nrow(l2_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l3_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l3_1.data = rbind(l3_1.data, tobind.data)
  }
}

print(l3_1.data)
```
No pattern.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l3_1.data$n,                           
                       y = c(l3_1.data$nm_percent_diff, l3_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l3_1.data)),
                                 rep("Moving Percent Difference", nrow(l3_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l4_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l4_1.data = rbind(l4_1.data, tobind.data)
  }
}

print(l4_1.data)
```
No pattern, it seems that changing the sample size while keeping the ratio constant has no effect on the variance estimation. However it appears that on average, using this ratio results in a slight underestimation of the variance, regardless of the sample size.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l4_1.data$n,                           
                       y = c(l4_1.data$nm_percent_diff, l4_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l4_1.data)),
                                 rep("Moving Percent Difference", nrow(l4_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```
Let's try it while setting l equal n^(1/3).

```{r functions, echo = False}
root3_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 8, 27, 64, 125, 216, 343, 512, 729, 1000, 1331, 1728, 2197, 2744, 3375))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, n**(1/3), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(n**(1/3)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root3_1.data = rbind(root3_1.data, tobind.data)
  }
}

print(root3_1.data)
```
It seems to begin to clearly underestimate around n = 81.

```{r functions, echo = False}

test_reshaped <- data.frame(x = root3_1.data$n,                           
                       y = c(root3_1.data$nm_percent_diff, root3_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root3_1.data)),
                                 rep("Moving Percent Difference", nrow(root3_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```
Let's try it while setting l equal n^(1/4).

```{r functions, echo = False}
root4_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 16, 81, 256, 625, 1296, 2401, 4096))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, n**(1/4), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(n**(1/4)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root4_1.data = rbind(root4_1.data, tobind.data)
  }
}

print(root4_1.data)
```
There seems to be a more steady increase in underestimation, until it drops to -1 when n = 1.

```{r functions, echo = False}

test_reshaped <- data.frame(x = root4_1.data$n,                           
                       y = c(root4_1.data$nm_percent_diff, root4_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root4_1.data)),
                                 rep("Moving Percent Difference", nrow(root4_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```

```{r functions, echo = False}
root5_1.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 32, 243, 1024, 3125, 7776))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.1, 0.1, n**(1/5), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.1),
     sigma = c(0.1),
     l = c(n**(1/5)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root5_1.data = rbind(root5_1.data, tobind.data)
  }
}

print(root5_1.data)
```
It is difficult to discern a pattern until it drops to -1 when n = 1. However, even at the higher n's, it seems to be somewhat underestimating the variance.

```{r functions, echo = False}

test_reshaped <- data.frame(x = root5_1.data$n,                           
                       y = c(root5_1.data$nm_percent_diff, root5_1.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root5_1.data)),
                                 rep("Moving Percent Difference", nrow(root5_1.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```
Let's conduct a simulation study with n = 100, ar = 0.5, and sd = 0.1 (var = 0.01). Let's first do this while keeping l = 10 constant.

```{r functions, echo = False}
c1_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c1_5.data = rbind(c1_5.data, tobind.data)
  }
}

print(c1_5.data)
```
No clear pattern, but it seems to significantly underestimate the variance on average.

```{r functions, echo = False}
install.packages("ggplot2")
library(ggplot2)

test_reshaped <- data.frame(x = c1_5.data$n,                           
                       y = c(c1_5.data$nm_percent_diff, c1_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c1_5.data)),
                                 rep("Moving Percent Difference", nrow(c1_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
c2_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c2_5.data = rbind(c2_5.data, tobind.data)
  }
}

print(c2_5.data)
```
Again, no super clear pattern but it seems to underestimate the variance on average at this range of sample sizes.

```{r functions, echo = False}

test_reshaped <- data.frame(x = c2_5.data$n,                           
                       y = c(c2_5.data$nm_percent_diff, c2_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c2_5.data)),
                                 rep("Moving Percent Difference", nrow(c2_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
c3_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c3_5.data = rbind(c3_5.data, tobind.data)
  }
}

print(c3_5.data)
```

The underestimation begins to become far more noticeable around n = 80.

```{r functions, echo = False}

test_reshaped <- data.frame(x = c3_5.data$n,                           
                       y = c(c3_5.data$nm_percent_diff, c3_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c3_5.data)),
                                 rep("Moving Percent Difference", nrow(c3_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
c4_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c4_5.data = rbind(c4_5.data, tobind.data)
  }
}

print(c4_5.data)
```

At this range, there seems to be a drop either at n = 70 or n = 50.

```{r functions, echo = False}

test_reshaped <- data.frame(x = c4_5.data$n,                           
                       y = c(c4_5.data$nm_percent_diff, c4_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c4_5.data)),
                                 rep("Moving Percent Difference", nrow(c4_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

Let's try this while keeping the ratio n/l = 10 constant.

```{r functions, echo = False}
l1_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l1_5.data = rbind(l1_5.data, tobind.data)
  }
}

print(l1_5.data)
```

No clear pattern. Seems to slightly underestimate on average.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l1_5.data$n,                           
                       y = c(l1_5.data$nm_percent_diff, l1_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l1_5.data)),
                                 rep("Moving Percent Difference", nrow(l1_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l2_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l2_5.data = rbind(l2_5.data, tobind.data)
  }
}

print(l2_5.data)
```
Pattern is still not very clear at this level.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l2_5.data$n,                           
                       y = c(l2_5.data$nm_percent_diff, l2_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l2_5.data)),
                                 rep("Moving Percent Difference", nrow(l2_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l3_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l3_5.data = rbind(l3_5.data, tobind.data)
  }
}

print(l3_5.data)
```

Noticeable drop at n = 60.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l3_5.data$n,                           
                       y = c(l3_5.data$nm_percent_diff, l3_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l3_5.data)),
                                 rep("Moving Percent Difference", nrow(l3_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l4_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l4_5.data = rbind(l4_5.data, tobind.data)
  }
}

print(l4_5.data)
```
Noticeable drop around n = 60.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l4_5.data$n,                           
                       y = c(l4_5.data$nm_percent_diff, l4_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l4_5.data)),
                                 rep("Moving Percent Difference", nrow(l4_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

l = n^(1/3)

```{r functions, echo = False}
root3_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 8, 27, 64, 125, 216, 343, 512, 729, 1000, 1331, 1728, 2197, 2744, 3375))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, n**(1/3), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(n**(1/3)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root3_5.data = rbind(root3_5.data, tobind.data)
  }
}

print(root3_5.data)
```
Noticeable drop around n = 64.


```{r functions, echo = False}

test_reshaped <- data.frame(x = root3_5.data$n,                           
                       y = c(root3_5.data$nm_percent_diff, root3_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root3_5.data)),
                                 rep("Moving Percent Difference", nrow(root3_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```

l = n^(1/4)

```{r functions, echo = False}
root4_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 16, 81, 256, 625, 1296, 2401, 4096))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, n**(1/4), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(n**(1/4)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root4_5.data = rbind(root4_5.data, tobind.data)
  }
}

print(root4_5.data)
```
Noticeable drop around n = 256. Even higher sample sizes result in underestimation.

```{r functions, echo = False}

test_reshaped <- data.frame(x = root4_5.data$n,                           
                       y = c(root4_5.data$nm_percent_diff, root4_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root4_5.data)),
                                 rep("Moving Percent Difference", nrow(root4_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```

l = n^(1/5)

```{r functions, echo = False}
root5_5.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 32, 243, 1024, 3125, 7776))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.5, 0.1, n**(1/5), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.5),
     sigma = c(0.1),
     l = c(n**(1/5)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root5_5.data = rbind(root5_5.data, tobind.data)
  }
}

print(root5_5.data)
```

Drop around n = 243. Again, even the higher sample sizes result in underestimation.

```{r functions, echo = False}

test_reshaped <- data.frame(x = root5_5.data$n,                           
                       y = c(root5_5.data$nm_percent_diff, root5_5.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root5_5.data)),
                                 rep("Moving Percent Difference", nrow(root5_5.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```

Let's conduct a simulation study with n = 100, ar = 0.9, and sd = 0.1 (var = 0.01). Let's first do this while keeping l = 10 constant.

```{r functions, echo = False}
c1_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c1_9.data = rbind(c1_9.data, tobind.data)
  }
}

print(c1_9.data)
```

Pattern is not super clear at this range, but it clearly seems to underestimate as the ar is much larger.

```{r functions, echo = False}

test_reshaped <- data.frame(x = c1_9.data$n,                           
                       y = c(c1_9.data$nm_percent_diff, c1_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c1_9.data)),
                                 rep("Moving Percent Difference", nrow(c1_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
c2_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c2_9.data = rbind(c2_9.data, tobind.data)
  }
}

print(c2_9.data)
```

Drop around n = 150.

```{r functions, echo = False}

test_reshaped <- data.frame(x = c2_9.data$n,                           
                       y = c(c2_9.data$nm_percent_diff, c2_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c2_9.data)),
                                 rep("Moving Percent Difference", nrow(c2_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
c3_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c3_9.data = rbind(c3_9.data, tobind.data)
  }
}

print(c3_9.data)
```

Drops significantly around n = 120.

```{r functions, echo = False}

test_reshaped <- data.frame(x = c3_9.data$n,                           
                       y = c(c3_9.data$nm_percent_diff, c3_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c3_9.data)),
                                 rep("Moving Percent Difference", nrow(c3_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
c4_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, 10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    c4_9.data = rbind(c4_9.data, tobind.data)
  }
}

print(c4_9.data)
```

Drop becomes more perceivable near n = 110.

```{r functions, echo = False}
install.packages("ggplot2")
library(ggplot2)

test_reshaped <- data.frame(x = c4_9.data$n,                           
                       y = c(c4_9.data$nm_percent_diff, c4_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(c4_9.data)),
                                 rep("Moving Percent Difference", nrow(c4_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l1_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(100, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700, 1800, 1900, 2000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l1_9.data = rbind(l1_9.data, tobind.data)
  }
}

print(l1_9.data)
```

Increase in underestimation becomes more noticeable around n = 1000.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l1_9.data$n,                           
                       y = c(l1_9.data$nm_percent_diff, l1_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l1_9.data)),
                                 rep("Moving Percent Difference", nrow(l1_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l2_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 550, 600, 650, 700, 750, 800, 850, 900, 950, 1000))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l2_9.data = rbind(l2_9.data, tobind.data)
  }
}

print(l2_9.data)
```

Noticeable increase in underestimation as n decrease for the majority of this range of sample sizes. Becomes even more noticeable n = 450.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l2_9.data$n,                           
                       y = c(l2_9.data$nm_percent_diff, l2_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l2_9.data)),
                                 rep("Moving Percent Difference", nrow(l2_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l3_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(20, 40, 60, 80, 100, 120, 140, 160, 180, 200, 220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 500))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l3_9.data = rbind(l3_9.data, tobind.data)
  }
}

print(l3_9.data)
```

Noticeable increase in underestimation as n decrease for the majority of this range of sample sizes. Becomes even more noticeable n = 250.

```{r functions, echo = False}

test_reshaped <- data.frame(x = l3_9.data$n,                           
                       y = c(l3_9.data$nm_percent_diff, l3_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l3_9.data)),
                                 rep("Moving Percent Difference", nrow(l3_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
l4_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, n/10, m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(n/10),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    l4_9.data = rbind(l4_9.data, tobind.data)
  }
}

print(l4_9.data)
```

Noticeable increase in underestimation as n decrease for this range of sample sizes. 


```{r functions, echo = False}
install.packages("ggplot2")
library(ggplot2)

test_reshaped <- data.frame(x = l4_9.data$n,                           
                       y = c(l4_9.data$nm_percent_diff, l4_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(l4_9.data)),
                                 rep("Moving Percent Difference", nrow(l4_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  geom_point()

```

```{r functions, echo = False}
root3_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 8, 27, 64, 125, 216, 343, 512, 729, 1000, 1331, 1728, 2197, 2744, 3375))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, n**(1/3), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(n**(1/3)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root3_9.data = rbind(root3_9.data, tobind.data)
  }
}

print(root3_9.data)
```

Underestimation increases as n decreases in a somewhat curvilinear pattern.

```{r functions, echo = False}
install.packages("ggplot2")
library(ggplot2)

test_reshaped <- data.frame(x = root3_9.data$n,                           
                       y = c(root3_9.data$nm_percent_diff, root3_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root3_9.data)),
                                 rep("Moving Percent Difference", nrow(root3_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```


```{r functions, echo = False}
root4_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 16, 81, 256, 625, 1296, 2401, 4096))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, n**(1/4), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(n**(1/4)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root4_9.data = rbind(root4_9.data, tobind.data)
  }
}

print(root4_9.data)
```

Underestimation increases as n decreases in a somewhat curvilinear pattern.

```{r functions, echo = False}

test_reshaped <- data.frame(x = root4_9.data$n,                           
                       y = c(root4_9.data$nm_percent_diff, root4_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root4_9.data)),
                                 rep("Moving Percent Difference", nrow(root4_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```

```{r functions, echo = False}
root5_9.data <- data.frame(
  
   n = c(),
   ar = c(),
   sigma = c(),
   l = c(),
   mean = c(), 
   nm_se = c(),
   nm_lower = c(), 
   nm_upper = c(),
   nm_success = c(),
   mv_se = c(),
   mv_lower = c(), 
   mv_upper = c(),
   mv_success = c(),
   true_se = c(),
   nm_diff = c(),
   mv_diff = c(),
   nm_percent_change = c(),
   mv_percent_change = c()
)

for(n in c(1, 32, 243, 1024, 3125, 7776))
{
  for(i in 1:3)
  {
    sim <- replicate(100, do1rep(n, 0.9, 0.1, n**(1/5), m1))
    m <- my_summary(sim)
    tobind.data <- data.frame(
     n = c(n),
     ar = c(0.9),
     sigma = c(0.1),
     l = c(n**(1/5)),
     mean = c(m[1]), 
     nm_se = c(m[2]),
     nm_lower = c(m[3]), 
     nm_upper = c(m[4]),
     nm_success = c(m[5]),
     mv_se = c(m[6]),
     mv_lower = c(m[7]), 
     mv_upper = c(m[8]),
     mv_success = c(m[9]),
     true_se = c(m[10]),
     nm_diff = c(m[11]),
     mv_diff = c(m[12]),
     nm_percent_diff = c(m[13]),
     mv_percent_diff = c(m[14])
    )
    root5_9.data = rbind(root5_9.data, tobind.data)
  }
}

print(root5_9.data)
```
Underestimation increases as n decreases in a somewhat curvilinear pattern.

```{r functions, echo = False}
install.packages("ggplot2")
library(ggplot2)

test_reshaped <- data.frame(x = root5_9.data$n,                           
                       y = c(root5_9.data$nm_percent_diff, root5_9.data$mv_percent_diff),
                       group = c(rep("Non-moving Percent Difference", nrow(root5_9.data)),
                                 rep("Moving Percent Difference", nrow(root5_9.data))))

ggplot(test_reshaped, aes(x, y, col = group)) +  scale_x_sqrt() + geom_point()

```